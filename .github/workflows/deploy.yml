name: Deploy Website on push

on:
  push:
    branches:
      - main

jobs:
    deploy-playground:
        name: Deploy Push Playground
        if: github.actor != 'dependabot[bot]' && !contains(github.event.head_commit.message, '[skip ci]') && github.repository == 'JackZong/vue-vexo-admin'
        runs-on: ubuntu-latest
        environment: PAXCQ

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup Node
            uses: ./.github/actions/setup-node

          - name: Build
            run: pnpm build

          - name: Zip dist
            run: |
                cd dist
                zip -r ../dist.zip .
                cd ..

          - name: Upload dist.zip
            uses: appleboy/scp-action@v0.1.7
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.PRIVATE_KEY }}
                source: dist.zip
                target: /tmp

          - name: Deploy on server
            uses: appleboy/ssh-action@v1.0.3
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.PRIVATE_KEY }}
                script: |
                    set -e
                    mkdir -p /www/wwwroot/vexo.paxcq.com
                    rm -rf /www/wwwroot/vexo.paxcq.com/dist
                    unzip -o /tmp/dist.zip -d /www/wwwroot/vexo.paxcq.com/dist
                    rm -f /tmp/dist.zip
                
    deploy-docs:
        name: Deploy Push Docs
        if: github.actor != 'dependabot[bot]' && !contains(github.event.head_commit.message, '[skip ci]') && github.repository == 'JackZong/vue-vexo-admin'
        runs-on: ubuntu-latest
        environment: PAXCQ

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup Node
            uses: ./.github/actions/setup-node

          - name: Build Docs
            run: pnpm docs:build

          - name: Zip docs dist
            run: |
                cd docs/.vitepress/dist
                zip -r ../../../docs-dist.zip .
                cd -

          - name: Upload docs-dist.zip
            uses: appleboy/scp-action@v0.1.7
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.PRIVATE_KEY }}
                source: docs-dist.zip
                target: /tmp

          - name: Deploy docs on server
            uses: appleboy/ssh-action@v1.0.3
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.PRIVATE_KEY }}
                script: |
                    set -e
                    mkdir -p /www/wwwroot/docs.paxcq.com
                    rm -rf /www/wwwroot/docs.paxcq.com/dist
                    unzip -o /tmp/docs-dist.zip -d /www/wwwroot/docs.paxcq.com/dist
                    rm -f /tmp/docs-dist.zip
